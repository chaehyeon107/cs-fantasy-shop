generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUM
//
enum ItemRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
  BUGGED
  SEGFAULT
}

//
// User
//
model User {
  id         Int     @id @default(autoincrement()) @map("id")
  email      String  @unique @map("email")
  password   String  @map("password")
  nickname   String  @map("nickname")
  role       String  @default("ROLE_USER") @map("role")
  provider   String  @default("local") @map("provider")
  providerId String? @map("provider_id")

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  cartItems CartItem[]
  orders      Order[]
  inventories Inventory[]

  @@index([provider, providerId])
  @@map("users")
}

//
// Category
//
model Category {
  id          Int     @id @default(autoincrement()) @map("id")
  name        String  @map("name")
  description String? @map("description")
  parentId    Int?    @map("parent_id")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  items Item[]   // âœ… CartItem ì§ì ‘ ì—°ê²° ì œê±°

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@map("categories")
}

//
// Item
//
model Item {
  id          Int     @id @default(autoincrement()) @map("id")
  name        String  @map("name")
  price       Int     @map("price")
  description String? @map("description")

  rarity  ItemRarity @default(COMMON) @map("rarity")
  statInt Int        @default(0) @map("stat_int")
  statStr Int        @default(0) @map("stat_str")
  statDex Int        @default(0) @map("stat_dex")
  statLck Int        @default(0) @map("stat_lck")

  csTag         String? @map("cs_tag")
  stockQuantity Int     @default(0) @map("stock_quantity")
  isActive      Boolean @default(true) @map("is_active")

  // ğŸ”— Category FK
  categoryId Int?       @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id])

  cartItems CartItem[]
  inventories Inventory[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([categoryId])
  @@index([price])
  @@index([rarity])
  @@index([csTag])
  @@index([createdAt])
  @@map("items")
}

//
// CartItem  âœ… ìµœì¢… ì •ë‹µ êµ¬ì¡°
//
model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  itemId    Int
  quantity  Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])   // âœ… ì¥ë°”êµ¬ë‹ˆ ì¤‘ë³µ ë°©ì§€ í•µì‹¬
  @@map("cart_items")
}

model Order {
  id         Int      @id @default(autoincrement())
  userId     Int
  status     String   @default("PAID")  // PENDING | PAID | CANCELLED ë“±ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥
  totalPrice Int

  createdAt DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id])
  orderItems OrderItem[]

  @@map("orders")
}

model OrderItem {
  id       Int @id @default(autoincrement())
  orderId  Int
  itemId   Int
  quantity Int
  price    Int   // ì£¼ë¬¸ ë‹¹ì‹œ ê°€ê²© ìŠ¤ëƒ…ìƒ·

  order Order @relation(fields: [orderId], references: [id])
  item  Item  @relation(fields: [itemId], references: [id])

  @@map("order_items")
}

model Inventory {
  id       Int @id @default(autoincrement())
  userId   Int
  itemId   Int
  quantity Int @default(0)

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
  @@map("inventories")
}
